# Синхронизация фильтров с URL параметрами

## Обзор

Реализована система сохранения и восстановления состояния фильтров каталога в URL параметрах. Это позволяет:

- Сохранять состояние фильтров при обновлении страницы
- Делиться ссылками с примененными фильтрами
- Поддерживать навигацию браузера (кнопки "Назад"/"Вперед")

## Компоненты системы

### 1. Утилиты для работы с URL (`src/utils/urlParams.ts`)

- `serializeFiltersToUrl()` - сериализация состояния фильтров в URL параметры
- `parseFiltersFromUrl()` - парсинг URL параметров в состояние фильтров
- `updateUrlParams()` - обновление URL без перезагрузки страницы
- `getCurrentUrlParams()` - получение текущих параметров из URL
- `hasActiveFiltersInUrl()` - проверка наличия активных фильтров в URL
- `clearUrlParams()` - очистка URL от параметров фильтров

### 2. Обновленный Store (`src/stores/useFiltersStore.ts`)

Добавлены новые функции:

- `syncWithUrl()` - синхронизация состояния с URL
- `updateUrlFromState()` - обновление URL из состояния
- `loadFromUrl()` - загрузка состояния из URL

Все функции обновления фильтров автоматически синхронизируются с URL.

### 3. Хуки для синхронизации

- `useUrlSync()` (`src/hooks/useUrlSync.ts`) - автоматическая синхронизация состояния с URL
- `useUrlChangeListener()` (`src/hooks/useUrlChangeListener.ts`) - обработка изменений URL при навигации
- `useInitialFiltersFromUrl()` (`src/hooks/useInitialFiltersFromUrl.ts`) - инициализация фильтров из URL при загрузке

## Использование

### Автоматическая синхронизация

Система работает автоматически. При изменении любых фильтров URL обновляется автоматически:

```typescript
// В компоненте
const { setFiltersData, setSelectedPropertyType } = useFiltersStore()

// При изменении фильтров URL обновляется автоматически
setFiltersData(newFiltersData)
setSelectedPropertyType("Квартира")
```

### Ручная синхронизация

```typescript
const { syncWithUrl, loadFromUrl } = useFiltersStore()

// Обновить URL из текущего состояния
syncWithUrl()

// Загрузить состояние из URL
loadFromUrl()
```

### Сброс фильтров

```typescript
const { resetFilters } = useFiltersStore()

// Сбросить фильтры и очистить URL
resetFilters()
```

## Структура URL параметров

URL параметры включают все поля фильтров:

```
/catalogue?propertyType=Квартира&district=Калининский&priceMin=5000000&priceMax=10000000&rooms=1,2&builder=ПИК,Самолет
```

### Основные параметры:

- `propertyType` - тип недвижимости для переключения ("Жилой комплекс" или "Квартира")
- `propertyTypeFilter` - фильтр по типу недвижимости ("Квартира" или "ЖК")
- `district` - район
- `builder` - застройщики (через запятую)
- `priceMin`/`priceMax` - диапазон цен
- `rooms` - количество комнат (через запятую)
- `metro` - станция метро
- И другие параметры фильтров

**Важно:** `propertyType` и `propertyTypeFilter` - это разные параметры:

- `propertyType` - управляет переключением между "Жилой комплекс" и "Квартира"
- `propertyTypeFilter` - это фильтр внутри формы фильтров

## Особенности реализации

1. **Автоматическая синхронизация** - все изменения фильтров автоматически отражаются в URL
2. **Поддержка навигации** - кнопки "Назад"/"Вперед" браузера корректно восстанавливают состояние
3. **Обработка ошибок** - система gracefully обрабатывает некорректные URL параметры
4. **Производительность** - обновления URL происходят асинхронно через `setTimeout`
5. **Совместимость** - система работает с существующим кодом без изменений

## Примеры использования

### Сохранение фильтров в URL

```typescript
// При применении фильтров URL автоматически обновляется
const handleApplyFilters = (formData: FiltersFormData) => {
  // URL обновляется автоматически через store
  setFiltersData(formData)
}
```

### Восстановление фильтров из URL

```typescript
// При загрузке страницы фильтры автоматически восстанавливаются из URL
useInitialFiltersFromUrl()
```

### Очистка фильтров

```typescript
// При сбросе фильтров URL очищается
const handleResetFilters = () => {
  resetFilters() // URL очищается автоматически
}
```
